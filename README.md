## cwj_co_net



一个基于多协程多线程实现的网络库，可用于快捷的搭建各种服务器，包括包括但不现在于tcpserver,httpserver,rpc框架；

网络框架性能请看:[压测报告](doc/stress_report.md)

该网络库目前分为以下几个模块：

注：下面标注有`TODO`的是未完成，但有提上日程的模块

1. [日志模块](doc/日志模块.md)

日志模块是仿造log4j结构设计的同步日志系统，网络框架->N个Logger（管理LogAppender,负责派发日志事件给Appender）->M LogAppender(负责将日志事件输出到某个地方（终端/文件...）) -> LogFormatter(日志时间的格式处理器)

其Appeder，Formater主要利用了多态技术，实现自定义化的代码级别设置和调整
也可以利用后面的配置系统，完成配置文件级别的设置

2. 配置模块
基于YAML格式设计了配置系统，利用yaml-cpp库解析YAML文件，并利用**多态和模板偏特化**技术，实现复杂的YAML结果和C++结构的自动类型转化以及类型检查   

注：配置系统的原则就是：约定大于配置，配置只是修改原有规定

3. 线程模块

封装了pthread,信号量以及Linux各种提供的各种锁，并用CAS操作实现了自己的自选锁，并利用RAII机制以及模板计算，实现了类似std::unique_lock的锁管理机制

4. 协程模块

利用ucontext_t结构体封装协程上下文，实现了对称有栈协程，通过修改默认参数以及配合后面的协程调度模块，可实现非对称有栈协程

5. 协程模块
6. 协程调度器模块

利用同步机制，实现消费者生产者模型的N-M的协程调度器，即1调度器-N线程-M协程，对同一个任务队列进行调度

具体实现模块:
    a. IO协程调度器(epoll)
        即利用epoll实现了任务的生产和调度

    b. 条件变量调度器(相当于线程池)
        即利用C++11提供的条件变量进行任务的生产
    
7. 定时器模块（红黑树+epoll , \[ 时间轮（TODO）\]）

利用红黑树+epoll的超时机制实现的定时器模块

8. hook模块（重构系统调用）

利用hook+IO协程调度器+定时器技术，重新实现了原有的网络IO接口，使其以同步方式实现异步的性能

9. Address模块（屏蔽各种类型地址）

利用继承和多态技术，分装ipv4,ip6,unix地址，屏蔽底层差别   

10. Socket模块（屏蔽各种socket模块）

利用继承和多态技术，封装了ipv4,ip6,unix的数据包，字节流socket，屏蔽底层差别

11. ByteArray模块（仿环形链表）

利用链表+空间复用技术，实现空间的动态扩容，以及减少扩容开销    

12. Stream模块

屏蔽流的实现，但其目前没啥作用    

13. Tcpserver模块（提供了两种封装好的Tcpserver以便使用）

封装了两个服务器类：TcpServer和MoreTcpServer，其中MoreTcpServer利用eventfd实现协程的资源同步解决了文件描述符达到极限，accept无限循环调用问题    

14. 客户端模块（支持UDP,TCP）,

封装了一个简易的客户端    

15. 内存池模块

利用jemalloc将全局的new/delete运算符以及协程栈空间配置器重新实现一般（但性能一般）    

16. 数据库模块（TODO）
    1. 数据库连接池（mysql,redis）（TODO）
    2. 客户端使用封装（TODO）
17. 守护进程模块（TODO）
18. 协程池模块：其是分离式协程池设计

其分为两个部分：线程私有协程池和全局协程池，私有池为了避免锁竞争，全局池为了避免某个线程占据太多空闲协程


## TODO    
例子
 
1. http模块（已完成）

利用http_parser库封装了一个http_server服务器实现，利用其可快速搭建http服务器   

2. rpc框架（TODO）
3. 分布式K-V存储服务（TODO）